<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Biblioteca Online</title>
    <style>
        :root { color-scheme: light dark; }
        * { box-sizing: border-box; }
        body { font-family: "Segoe UI", Arial, sans-serif; margin: 0; background: #f0f4f9; color: #22303c; }
        header { background: linear-gradient(120deg, #1a73e8, #4f8ef7); color: #fff; padding: 32px 24px; }
        header h1 { margin: 0 0 8px; font-size: 32px; }
        header p { margin: 0; font-size: 16px; opacity: 0.9; }
        main { max-width: 1200px; margin: 0 auto; padding: 32px 16px 64px; display: grid; gap: 24px; }
        section { background: #fff; border-radius: 14px; padding: 24px; box-shadow: 0 16px 40px rgba(26, 115, 232, 0.08); }
        section h2 { margin: 0 0 16px; font-size: 24px; color: #1a3d6d; }
        form { display: grid; gap: 14px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); margin-bottom: 16px; }
        label { display: flex; flex-direction: column; font-size: 14px; color: #5b6a7d; }
        input, select, textarea { margin-top: 6px; padding: 10px; border-radius: 8px; border: 1px solid #c7d0dd; font-size: 15px; background: #f9fbff; }
        textarea { resize: vertical; min-height: 72px; }
        button { padding: 12px 18px; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; transition: transform 0.15s ease, box-shadow 0.15s ease; }
        button.primary { background: #1a73e8; color: #fff; }
        button.secondary { background: #fff; border: 1px solid #1a73e8; color: #1a73e8; }
        button.danger { background: #e53935; color: #fff; }
        button:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 14px; }
        th, td { padding: 10px 12px; border-bottom: 1px solid #e5ecf6; text-align: left; vertical-align: top; }
        th { background: #f3f7ff; color: #3c4a5c; font-weight: 600; }
        tbody tr:hover { background: #f8fbff; }
        .actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .message { font-size: 14px; margin-top: -6px; min-height: 20px; }
        .message.success { color: #1e8e3e; }
        .message.error { color: #d93025; }
        .grid-two { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; }
        .badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 600; }
        .badge.available { background: #e8f5e9; color: #1e8e3e; }
        .badge.unavailable { background: #ffebee; color: #d93025; }
        @media (max-width: 768px) { header { text-align: center; } }
    </style>
</head>
<body>
<header>
    <h1>Biblioteca Online</h1>
    <p>Gerencie livros, leitores e empréstimos diretamente pelo navegador.</p>
</header>
<main>
    <section id="books-section">
        <div class="grid-two">
            <div>
                <h2>Cadastro de Livros</h2>
                <form id="book-create-form">
                    <label>Título
                        <input type="text" name="title" maxlength="200" required>
                    </label>
                    <label>Autor
                        <input type="text" name="author" maxlength="120" required>
                    </label>
                    <label>Gênero
                        <input type="text" name="genre" maxlength="80">
                    </label>
                    <div class="actions" style="grid-column: 1 / -1;">
                        <button type="submit" class="primary">Adicionar Livro</button>
                        <button type="button" class="secondary" id="book-create-reset">Limpar</button>
                    </div>
                </form>
                <div class="message" id="books-message"></div>
            </div>
            <div>
                <h2>Editar Livro</h2>
                <form id="book-update-form">
                    <label>ID do Livro
                        <input type="number" name="id" min="1" required>
                    </label>
                    <label>Título
                        <input type="text" name="title" maxlength="200" required>
                    </label>
                    <label>Autor
                        <input type="text" name="author" maxlength="120" required>
                    </label>
                    <label>Gênero
                        <input type="text" name="genre" maxlength="80">
                    </label>
                    <label>Disponível
                        <select name="available">
                            <option value="true">Sim</option>
                            <option value="false">Não</option>
                        </select>
                    </label>
                    <div class="actions" style="grid-column: 1 / -1;">
                        <button type="submit" class="primary">Atualizar Livro</button>
                        <button type="button" class="secondary" id="book-update-reset">Limpar</button>
                    </div>
                </form>
            </div>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-top:16px;">
            <h3 style="margin:0; color:#264d79;">Lista de Livros</h3>
            <button type="button" class="secondary" id="books-refresh">Recarregar</button>
        </div>
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Título</th>
                <th>Autor</th>
                <th>Gênero</th>
                <th>Status</th>
                <th>Ações</th>
            </tr>
            </thead>
            <tbody id="books-table">
            <tr><td colspan="6">Nenhum livro cadastrado.</td></tr>
            </tbody>
        </table>
    </section>

    <section id="readers-section">
        <div class="grid-two">
            <div>
                <h2>Cadastro de Leitores</h2>
                <form id="reader-create-form">
                    <label>Nome
                        <input type="text" name="name" maxlength="120" required>
                    </label>
                    <label>E-mail
                        <input type="email" name="email" maxlength="150" required>
                    </label>
                    <label>Telefone
                        <input type="text" name="phone" maxlength="14" placeholder="(00) 00000-0000">
                    </label>
                    <div class="actions" style="grid-column: 1 / -1;">
                        <button type="submit" class="primary">Adicionar Leitor</button>
                        <button type="button" class="secondary" id="reader-create-reset">Limpar</button>
                    </div>
                </form>
                <div class="message" id="readers-message"></div>
            </div>
            <div>
                <h2>Editar Leitor</h2>
                <form id="reader-update-form">
                    <label>ID do Leitor
                        <input type="number" name="id" min="1" required>
                    </label>
                    <label>Nome
                        <input type="text" name="name" maxlength="120" required>
                    </label>
                    <label>E-mail
                        <input type="email" name="email" maxlength="150" required>
                    </label>
                    <label>Telefone
                        <input type="text" name="phone" maxlength="14">
                    </label>
                    <div class="actions" style="grid-column: 1 / -1;">
                        <button type="submit" class="primary">Atualizar Leitor</button>
                        <button type="button" class="secondary" id="reader-update-reset">Limpar</button>
                    </div>
                </form>
            </div>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-top:16px;">
            <h3 style="margin:0; color:#264d79;">Lista de Leitores</h3>
            <button type="button" class="secondary" id="readers-refresh">Recarregar</button>
        </div>
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>E-mail</th>
                <th>Telefone</th>
                <th>Desde</th>
                <th>Ações</th>
            </tr>
            </thead>
            <tbody id="readers-table">
            <tr><td colspan="6">Nenhum leitor cadastrado.</td></tr>
            </tbody>
        </table>
    </section>

    <section id="loans-section">
        <h2>Controle de Empréstimos</h2>
        <form id="loan-create-form">
            <label>Livro
                <select name="bookId" required></select>
            </label>
            <label>Leitor
                <select name="readerId" required></select>
            </label>
            <label>Data de Empréstimo
                <input type="date" name="loanDate" required>
            </label>
            <label>Data de Devolução Prevista
                <input type="date" name="dueDate" required>
            </label>
            <div class="actions" style="grid-column: 1 / -1;">
                <button type="submit" class="primary">Registrar Empréstimo</button>
                <button type="button" class="secondary" id="loan-create-reset">Limpar</button>
            </div>
        </form>
        <div class="message" id="loans-message"></div>
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-top:16px;">
            <h3 style="margin:0; color:#264d79;">Empréstimos Atuais</h3>
            <button type="button" class="secondary" id="loans-refresh">Recarregar</button>
        </div>
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Livro</th>
                <th>Leitor</th>
                <th>Retirada</th>
                <th>Previsto</th>
                <th>Devolvido</th>
                <th>Ações</th>
            </tr>
            </thead>
            <tbody id="loans-table">
            <tr><td colspan="7">Nenhum empréstimo registrado.</td></tr>
            </tbody>
        </table>
    </section>
</main>
<script>
    const api = {
        books: '/api/books',
        readers: '/api/readers',
        loans: '/api/loans'
    };

    const state = {
        books: [],
        readers: [],
        loans: []
    };

    const elements = {
        booksTable: document.getElementById('books-table'),
        readersTable: document.getElementById('readers-table'),
        loansTable: document.getElementById('loans-table'),
        bookSelect: document.querySelector('#loan-create-form select[name="bookId"]'),
        readerSelect: document.querySelector('#loan-create-form select[name="readerId"]'),
        messages: {
            books: document.getElementById('books-message'),
            readers: document.getElementById('readers-message'),
            loans: document.getElementById('loans-message')
        }
    };

    function showMessage(target, text, type = 'success') {
        const box = elements.messages[target];
        if (!box) return;
        box.textContent = text;
        box.className = `message ${type}`;
        if (text) {
            setTimeout(() => {
                if (box.textContent === text) {
                    box.textContent = '';
                    box.className = 'message';
                }
            }, 4000);
        }
    }

    function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString + 'T00:00:00');
        return date.toLocaleDateString('pt-BR');
    }

    async function fetchJson(url, options = {}) {
        const response = await fetch(url, {
            headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
            ...options
        });
        if (!response.ok) {
            try {
                const error = await response.json();
                throw new Error(error.message || 'Operação não pôde ser concluída.');
            } catch (err) {
                throw new Error('Operação não pôde ser concluída.');
            }
        }
        return response.status === 204 ? null : response.json();
    }

    function renderBooks() {
        const { books } = state;
        if (!books.length) {
            elements.booksTable.innerHTML = '<tr><td colspan="6">Nenhum livro cadastrado.</td></tr>';
        } else {
            elements.booksTable.innerHTML = '';
            books.forEach(book => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${book.id}</td>
                    <td>${book.title}</td>
                    <td>${book.author}</td>
                    <td>${book.genre ?? '-'}</td>
                    <td>
                        <span class="badge ${book.available ? 'available' : 'unavailable'}">
                            ${book.available ? 'Disponível' : 'Emprestado'}
                        </span>
                    </td>
                    <td class="actions">
                        <button type="button" class="secondary" data-action="edit-book" data-id="${book.id}">Editar</button>
                        <button type="button" class="danger" data-action="delete-book" data-id="${book.id}">Excluir</button>
                    </td>`;
                elements.booksTable.appendChild(tr);
            });
        }
        renderBookOptions();
    }

    function renderBookOptions() {
        const availableBooks = state.books.filter(book => book.available);
        elements.bookSelect.innerHTML = availableBooks.length
            ? '<option value="" disabled selected>Selecione um livro</option>'
            : '<option value="" disabled selected>Nenhum livro disponível</option>';
        availableBooks.forEach(book => {
            const option = document.createElement('option');
            option.value = book.id;
            option.textContent = `${book.title} (${book.author})`;
            elements.bookSelect.appendChild(option);
        });
    }

    function renderReaders() {
        const { readers } = state;
        if (!readers.length) {
            elements.readersTable.innerHTML = '<tr><td colspan="6">Nenhum leitor cadastrado.</td></tr>';
        } else {
            elements.readersTable.innerHTML = '';
            readers.forEach(reader => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${reader.id}</td>
                    <td>${reader.name}</td>
                    <td>${reader.email}</td>
                    <td>${reader.phone ?? '-'}</td>
                    <td>${formatDate(reader.registrationDate)}</td>
                    <td class="actions">
                        <button type="button" class="secondary" data-action="edit-reader" data-id="${reader.id}">Editar</button>
                        <button type="button" class="danger" data-action="delete-reader" data-id="${reader.id}">Excluir</button>
                    </td>`;
                elements.readersTable.appendChild(tr);
            });
        }
        renderReaderOptions();
    }

    function renderReaderOptions() {
        elements.readerSelect.innerHTML = state.readers.length
            ? '<option value="" disabled selected>Selecione um leitor</option>'
            : '<option value="" disabled selected>Nenhum leitor cadastrado</option>';
        state.readers.forEach(reader => {
            const option = document.createElement('option');
            option.value = reader.id;
            option.textContent = `${reader.name} (${reader.email})`;
            elements.readerSelect.appendChild(option);
        });
    }

    function renderLoans() {
        const { loans } = state;
        if (!loans.length) {
            elements.loansTable.innerHTML = '<tr><td colspan="7">Nenhum empréstimo registrado.</td></tr>';
        } else {
            elements.loansTable.innerHTML = '';
            loans.forEach(loan => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${loan.id}</td>
                    <td>${loan.bookTitle} (ID ${loan.bookId})</td>
                    <td>${loan.readerName} (ID ${loan.readerId})</td>
                    <td>${formatDate(loan.loanDate)}</td>
                    <td>${formatDate(loan.dueDate)}</td>
                    <td>${loan.returned ? formatDate(loan.returnDate) : '<span class="badge unavailable">Em aberto</span>'}</td>
                    <td class="actions">
                        ${loan.returned ? '' : `<button type="button" class="primary" data-action="return-loan" data-id="${loan.id}">Registrar devolução</button>`}
                        <button type="button" class="danger" data-action="delete-loan" data-id="${loan.id}">Excluir</button>
                    </td>`;
                elements.loansTable.appendChild(tr);
            });
        }
    }

    async function loadBooks() {
        try {
            state.books = await fetchJson(api.books);
            renderBooks();
        } catch (error) {
            showMessage('books', error.message, 'error');
        }
    }

    async function loadReaders() {
        try {
            state.readers = await fetchJson(api.readers);
            renderReaders();
        } catch (error) {
            showMessage('readers', error.message, 'error');
        }
    }

    async function loadLoans() {
        try {
            state.loans = await fetchJson(api.loans);
            renderLoans();
        } catch (error) {
            showMessage('loans', error.message, 'error');
        }
    }

    function getFormValues(form) {
        const formData = new FormData(form);
        return Object.fromEntries(formData.entries());
    }

    document.getElementById('book-create-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const values = getFormValues(event.target);
        try {
            await fetchJson(api.books, {
                method: 'POST',
                body: JSON.stringify({
                    title: values.title,
                    author: values.author,
                    genre: values.genre || null,
                    available: true
                })
            });
            event.target.reset();
            showMessage('books', 'Livro cadastrado com sucesso!');
            await loadBooks();
        } catch (error) {
            showMessage('books', error.message, 'error');
        }
    });

    document.getElementById('book-update-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const values = getFormValues(event.target);
        if (!values.id) {
            showMessage('books', 'Informe o ID do livro.', 'error');
            return;
        }
        try {
            await fetchJson(`${api.books}/${values.id}`, {
                method: 'PUT',
                body: JSON.stringify({
                    title: values.title,
                    author: values.author,
                    genre: values.genre || null,
                    available: values.available === 'true'
                })
            });
            showMessage('books', 'Livro atualizado com sucesso!');
            await loadBooks();
        } catch (error) {
            showMessage('books', error.message, 'error');
        }
    });

    elements.booksTable.addEventListener('click', async (event) => {
        const button = event.target.closest('button[data-action]');
        if (!button) return;
        const id = button.dataset.id;
        if (button.dataset.action === 'edit-book') {
            try {
                const book = await fetchJson(`${api.books}/${id}`);
                const form = document.getElementById('book-update-form');
                form.id.value = book.id;
                form.title.value = book.title;
                form.author.value = book.author;
                form.genre.value = book.genre ?? '';
                form.available.value = String(book.available);
                showMessage('books', 'Livro carregado para edição.');
                window.scrollTo({ top: form.offsetTop - 20, behavior: 'smooth' });
            } catch (error) {
                showMessage('books', error.message, 'error');
            }
        }
        if (button.dataset.action === 'delete-book') {
            if (!confirm('Confirma remover este livro?')) return;
            try {
                await fetchJson(`${api.books}/${id}`, { method: 'DELETE' });
                showMessage('books', 'Livro removido.');
                await loadBooks();
            } catch (error) {
                showMessage('books', error.message, 'error');
            }
        }
    });

    document.getElementById('reader-create-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const values = getFormValues(event.target);
        try {
            await fetchJson(api.readers, {
                method: 'POST',
                body: JSON.stringify(values)
            });
            event.target.reset();
            showMessage('readers', 'Leitor cadastrado com sucesso!');
            await loadReaders();
        } catch (error) {
            showMessage('readers', error.message, 'error');
        }
    });

    document.getElementById('reader-update-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const values = getFormValues(event.target);
        if (!values.id) {
            showMessage('readers', 'Informe o ID do leitor.', 'error');
            return;
        }
        try {
            await fetchJson(`${api.readers}/${values.id}`, {
                method: 'PUT',
                body: JSON.stringify({
                    name: values.name,
                    email: values.email,
                    phone: values.phone || null
                })
            });
            showMessage('readers', 'Leitor atualizado com sucesso!');
            await loadReaders();
        } catch (error) {
            showMessage('readers', error.message, 'error');
        }
    });

    elements.readersTable.addEventListener('click', async (event) => {
        const button = event.target.closest('button[data-action]');
        if (!button) return;
        const id = button.dataset.id;
        if (button.dataset.action === 'edit-reader') {
            try {
                const reader = await fetchJson(`${api.readers}/${id}`);
                const form = document.getElementById('reader-update-form');
                form.id.value = reader.id;
                form.name.value = reader.name;
                form.email.value = reader.email;
                form.phone.value = reader.phone ?? '';
                showMessage('readers', 'Leitor carregado para edição.');
                window.scrollTo({ top: form.offsetTop - 20, behavior: 'smooth' });
            } catch (error) {
                showMessage('readers', error.message, 'error');
            }
        }
        if (button.dataset.action === 'delete-reader') {
            if (!confirm('Confirma remover este leitor?')) return;
            try {
                await fetchJson(`${api.readers}/${id}`, { method: 'DELETE' });
                showMessage('readers', 'Leitor removido.');
                await Promise.all([loadReaders(), loadLoans(), loadBooks()]);
            } catch (error) {
                showMessage('readers', error.message, 'error');
            }
        }
    });

    document.getElementById('loan-create-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const values = getFormValues(event.target);
        if (!values.bookId || !values.readerId) {
            showMessage('loans', 'Selecione livro e leitor.', 'error');
            return;
        }
        try {
            await fetchJson(api.loans, {
                method: 'POST',
                body: JSON.stringify({
                    bookId: Number(values.bookId),
                    readerId: Number(values.readerId),
                    loanDate: values.loanDate,
                    dueDate: values.dueDate
                })
            });
            showMessage('loans', 'Empréstimo registrado com sucesso!');
            event.target.reset();
            setLoanDatesDefault();
            await Promise.all([loadLoans(), loadBooks()]);
        } catch (error) {
            showMessage('loans', error.message, 'error');
        }
    });

    elements.loansTable.addEventListener('click', async (event) => {
        const button = event.target.closest('button[data-action]');
        if (!button) return;
        const id = button.dataset.id;
        if (button.dataset.action === 'return-loan') {
            if (!confirm('Registrar devolução deste empréstimo?')) return;
            const today = new Date().toISOString().slice(0, 10);
            try {
                await fetchJson(`${api.loans}/${id}/return`, {
                    method: 'PATCH',
                    body: JSON.stringify({ returnDate: today })
                });
                showMessage('loans', 'Devolução registrada.');
                await Promise.all([loadLoans(), loadBooks()]);
            } catch (error) {
                showMessage('loans', error.message, 'error');
            }
        }
        if (button.dataset.action === 'delete-loan') {
            if (!confirm('Excluir este empréstimo?')) return;
            try {
                await fetchJson(`${api.loans}/${id}`, { method: 'DELETE' });
                showMessage('loans', 'Empréstimo excluído.');
                await Promise.all([loadLoans(), loadBooks()]);
            } catch (error) {
                showMessage('loans', error.message, 'error');
            }
        }
    });

    document.getElementById('books-refresh').addEventListener('click', loadBooks);
    document.getElementById('readers-refresh').addEventListener('click', loadReaders);
    document.getElementById('loans-refresh').addEventListener('click', () => Promise.all([loadLoans(), loadBooks()]));

    document.getElementById('book-create-reset').addEventListener('click', () => document.getElementById('book-create-form').reset());
    document.getElementById('book-update-reset').addEventListener('click', () => document.getElementById('book-update-form').reset());
    document.getElementById('reader-create-reset').addEventListener('click', () => document.getElementById('reader-create-form').reset());
    document.getElementById('reader-update-reset').addEventListener('click', () => document.getElementById('reader-update-form').reset());
    document.getElementById('loan-create-reset').addEventListener('click', () => {
        document.getElementById('loan-create-form').reset();
        setLoanDatesDefault();
    });

    function setLoanDatesDefault() {
        const form = document.getElementById('loan-create-form');
        const today = new Date().toISOString().slice(0, 10);
        form.loanDate.value = today;
        const due = new Date();
        due.setDate(due.getDate() + 7);
        form.dueDate.value = due.toISOString().slice(0, 10);
    }

    async function bootstrap() {
        setLoanDatesDefault();
        await Promise.all([loadBooks(), loadReaders(), loadLoans()]);
    }

    bootstrap();
</script>
</body>
</html>